#!/usr/bin/env python
# -*- coding: utf-8 -*-

from flask import Flask, request
from contextlib import contextmanager

import threading
import sqlite3
import os
import re

app = Flask(__name__)
local = threading.local()
config = {}
config['dbname'] = 'clog.db'

def getdb():
    if not hasattr(local, 'db'):
        local.db = sqlite3.connect(config['dbname'],
                                   detect_types=sqlite3.PARSE_DECLTYPES)
        local.db.row_factory = sqlite3.Row
    return local.db

def getcursor():
    return getdb().cursor()

@contextmanager
def db_trans():
    dbh = getdb()
    c = dbh.cursor()
    try:
        yield c
    except:
        dbh.rollback()
        raise
    finally:
        dbh.commit()

@app.route('/jobs', methods=['GET', 'POST'])
def jobs():
	if request.method == 'POST':
		start_time = request.form['start_time']
		end_time = request.form['end_time']
		status = request.form['status']
		script = request.form['script']
		output = request.form['output']
		computername = request.form['computername']
		computeruser = request.form['username']
		ip = request.remote_addr
		rid = request.form['id']
		if not re.match(r'^[a-f0-9-]{36}$', rid):
			raise ValueError('invalid rid')
		with open(config['dbname'] + '.logs/' + rid, 'w') as fp:
			fp.write(output)
		with db_trans() as c:
			c.execute("insert into jobhistory (id, script, computername, "
				"ip, computeruser, datestarted, datefinished, "
				"status) values (:rid, :script, :computername, :ip, "
				":computeruser, :start_time, :end_time, :status)",
				locals())
		return 'ok'

if __name__ == '__main__':
	app.debug = True
	app.run(host='127.0.0.1', port=7890)